<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Appointment Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        #hospital-details {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #hospital-details h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        #hospital-details p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        #hospital-details strong {
            color: #333;
        }
        .schedule-btn {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">Appointment Scheduler</a>
            <div class="navbar-nav">
                {% if current_user.is_authenticated %}
                <a class="nav-link" href="{{ url_for('health_record') }}">My Record/Appointments</a>
                {% if current_user.role == 'doctor' %}
                <a class="nav-link" href="{{ url_for('add_patient') }}">Add Patient</a>
                {% endif %}
                <a class="nav-link" href="{{ url_for('logout') }}">Log Out</a>
                {% else %}
                <a class="nav-link" href="{{ url_for('login') }}">Log In</a>
                {% endif %}
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h1>Welcome to Appointment Scheduler</h1>
        <p>View the locations of healthcare facilities on the map below and schedule appointments:</p>
        <div id="map"></div>
        <div id="hospital-details" class="card" style="display: none;">
            <div class="card-body">
                <h3 id="hospital-name"></h3>
                <p><strong>Address:</strong> <span id="hospital-address"></span></p>
                <p><strong>Specialties:</strong> <span id="hospital-specialties"></span></p>
                <p><strong>Doctors:</strong> <span id="hospital-doctors"></span></p>
                {% if current_user.is_authenticated and current_user.role in ['doctor', 'admin', 'patient'] %}
                <a id="schedule-btn" href="#" class="btn btn-primary schedule-btn">Schedule Appointment</a>
                {% else %}
                <p><small>Please log in to schedule an appointment.</small></p>
                {% endif %}
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([46.1512, 14.9955], 8); // Centar Slovenije
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var hospitals = {{ hospitals|tojson|safe }};
        var doctors = {{ doctors|tojson|safe }};

        // Logovanje za debagovanje
        console.log("Hospitals:", hospitals);
        console.log("Doctors:", doctors);

        // Provera da li su podaci validni, ako ne, postavi prazne nizove
        if (!Array.isArray(hospitals)) hospitals = [];
        if (!Array.isArray(doctors)) doctors = [];

        hospitals.forEach(function(hospital) {
            var latLng = [hospital.latitude, hospital.longitude];
            var marker = L.marker(latLng).addTo(map);

            marker.on('click', function() {
                var details = document.getElementById('hospital-details');
                var name = document.getElementById('hospital-name');
                var address = document.getElementById('hospital-address');
                var specialties = document.getElementById('hospital-specialties');
                var doctorsList = document.getElementById('hospital-doctors');
                var scheduleBtn = document.getElementById('schedule-btn');

                name.textContent = hospital.name;
                address.textContent = `${hospital.address}, ${hospital.city}`;

                // Filtriranje doktora po hospital_id
                var hospitalDoctors = doctors.filter(d => d.hospital_id === hospital.id);
                var specialtySet = new Set(hospitalDoctors.map(d => d.specialty));
                specialties.textContent = Array.from(specialtySet).join(', ') || 'No specialties available';
                doctorsList.textContent = hospitalDoctors.map(d => d.name).join(', ') || 'No doctors available';

                // Povezivanje dugmeta za zakazivanje
                if (scheduleBtn) {
                    scheduleBtn.href = "{{ url_for('add_appointment', patient_id=(current_user.id if current_user.is_authenticated and current_user.role == 'patient' else 1)) }}".replace('1', hospital.id);
                }

                details.style.display = 'block';
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>